# This schedule performs elementw-wise pruning of all convolutional, bathnorm and fully connected layers in MobileNetV2
# for first epoch

version: 1
pruners:
  # prune conv layers
  mobilenetv2_conv:
    class: 'SparsityLevelParameterPruner'
    # NOTE: group type may not be necessary for element-wise pruning
    group_type: Element
    # 20% sparsity for conv layers
    desired_sparsity: 0.2
    # NOTE: put in the names of the modules - get this from running model-summary.py in this dir
    weights: ['module.module.features.0.0.weight',
    # 'module.module.features.0.1.weight',
    'module.module.features.1.conv.0.weight',
    # 'module.module.features.1.conv.1.weight',
    'module.module.features.1.conv.3.weight',
    # 'module.module.features.1.conv.4.weight',
    'module.module.features.2.conv.0.weight',
    # 'module.module.features.2.conv.1.weight',
    'module.module.features.2.conv.3.weight',
    # 'module.module.features.2.conv.4.weight',
    'module.module.features.2.conv.6.weight',
    # 'module.module.features.2.conv.7.weight',
    'module.module.features.3.conv.0.weight',
    # 'module.module.features.3.conv.1.weight',
    'module.module.features.3.conv.3.weight',
    # 'module.module.features.3.conv.4.weight',
    'module.module.features.3.conv.6.weight',
    # 'module.module.features.3.conv.7.weight',
    'module.module.features.4.conv.0.weight',
    # 'module.module.features.4.conv.1.weight',
    'module.module.features.4.conv.3.weight',
    # 'module.module.features.4.conv.4.weight',
    'module.module.features.4.conv.6.weight',
    # 'module.module.features.4.conv.7.weight',
    'module.module.features.5.conv.0.weight',
    # 'module.module.features.5.conv.1.weight',
    'module.module.features.5.conv.3.weight',
    # 'module.module.features.5.conv.4.weight',
    'module.module.features.5.conv.6.weight',
    # 'module.module.features.5.conv.7.weight',
    'module.module.features.6.conv.0.weight',
    # 'module.module.features.6.conv.1.weight',
    'module.module.features.6.conv.3.weight',
    # 'module.module.features.6.conv.4.weight',
    'module.module.features.6.conv.6.weight',
    # 'module.module.features.6.conv.7.weight',
    'module.module.features.7.conv.0.weight',
    # 'module.module.features.7.conv.1.weight',
    'module.module.features.7.conv.3.weight',
    # 'module.module.features.7.conv.4.weight',
    'module.module.features.7.conv.6.weight',
    # 'module.module.features.7.conv.7.weight',
    'module.module.features.8.conv.0.weight',
    # 'module.module.features.8.conv.1.weight',
    'module.module.features.8.conv.3.weight',
    # 'module.module.features.8.conv.4.weight',
    'module.module.features.8.conv.6.weight',
    # 'module.module.features.8.conv.7.weight',
    'module.module.features.9.conv.0.weight',
    # 'module.module.features.9.conv.1.weight',
    'module.module.features.9.conv.3.weight',
    # 'module.module.features.9.conv.4.weight',
    'module.module.features.9.conv.6.weight',
    # 'module.module.features.9.conv.7.weight',
    'module.module.features.10.conv.0.weight',
    # 'module.module.features.10.conv.1.weight',
    'module.module.features.10.conv.3.weight',
    # 'module.module.features.10.conv.4.weight',
    'module.module.features.10.conv.6.weight',
    # 'module.module.features.10.conv.7.weight',
    'module.module.features.11.conv.0.weight',
    # 'module.module.features.11.conv.1.weight',
    'module.module.features.11.conv.3.weight',
    # 'module.module.features.11.conv.4.weight',
    'module.module.features.11.conv.6.weight',
    # 'module.module.features.11.conv.7.weight',
    'module.module.features.12.conv.0.weight',
    # 'module.module.features.12.conv.1.weight',
    'module.module.features.12.conv.3.weight',
    # 'module.module.features.12.conv.4.weight',
    'module.module.features.12.conv.6.weight',
    # 'module.module.features.12.conv.7.weight',
    'module.module.features.13.conv.0.weight',
    # 'module.module.features.13.conv.1.weight',
    'module.module.features.13.conv.3.weight',
    # 'module.module.features.13.conv.4.weight',
    'module.module.features.13.conv.6.weight',
    # 'module.module.features.13.conv.7.weight',
    'module.module.features.14.conv.0.weight',
    # 'module.module.features.14.conv.1.weight',
    'module.module.features.14.conv.3.weight',
    # 'module.module.features.14.conv.4.weight',
    'module.module.features.14.conv.6.weight',
    # 'module.module.features.14.conv.7.weight',
    'module.module.features.15.conv.0.weight',
    # 'module.module.features.15.conv.1.weight',
    'module.module.features.15.conv.3.weight',
    # 'module.module.features.15.conv.4.weight',
    'module.module.features.15.conv.6.weight',
    # 'module.module.features.15.conv.7.weight',
    'module.module.features.16.conv.0.weight',
    # 'module.module.features.16.conv.1.weight',
    'module.module.features.16.conv.3.weight',
    # 'module.module.features.16.conv.4.weight',
    'module.module.features.16.conv.6.weight',
    # 'module.module.features.16.conv.7.weight',
    'module.module.features.17.conv.0.weight',
    # 'module.module.features.17.conv.1.weight',
    'module.module.features.17.conv.3.weight',
    # 'module.module.features.17.conv.4.weight',
    'module.module.features.17.conv.6.weight',
    # 'module.module.features.17.conv.7.weight',
    'module.module.features.18.0.weight']
    # 'module.module.features.18.1.weight',
    # 'module.module.classifier.1.weight']

  mobilenetv2_batchnorm:
    class: 'SparsityLevelParameterPruner'
    group_type: Element
    # 20% sparsity of batchnorm layers
    desired_sparsity: 0.2
    weights: ['module.module.features.0.1.weight',
    # 'module.module.features.1.conv.0.weight',
    'module.module.features.1.conv.1.weight',
    # 'module.module.features.1.conv.3.weight',
    'module.module.features.1.conv.4.weight',
    # 'module.module.features.2.conv.0.weight',
    'module.module.features.2.conv.1.weight',
    # 'module.module.features.2.conv.3.weight',
    'module.module.features.2.conv.4.weight',
    # 'module.module.features.2.conv.6.weight',
    'module.module.features.2.conv.7.weight',
    # 'module.module.features.3.conv.0.weight',
    'module.module.features.3.conv.1.weight',
    # 'module.module.features.3.conv.3.weight',
    'module.module.features.3.conv.4.weight',
    # 'module.module.features.3.conv.6.weight',
    'module.module.features.3.conv.7.weight',
    # 'module.module.features.4.conv.0.weight',
    'module.module.features.4.conv.1.weight',
    # 'module.module.features.4.conv.3.weight',
    'module.module.features.4.conv.4.weight',
    # 'module.module.features.4.conv.6.weight',
    'module.module.features.4.conv.7.weight',
    # 'module.module.features.5.conv.0.weight',
    'module.module.features.5.conv.1.weight',
    # 'module.module.features.5.conv.3.weight',
    'module.module.features.5.conv.4.weight',
    # 'module.module.features.5.conv.6.weight',
    'module.module.features.5.conv.7.weight',
    # 'module.module.features.6.conv.0.weight',
    'module.module.features.6.conv.1.weight',
    # 'module.module.features.6.conv.3.weight',
    'module.module.features.6.conv.4.weight',
    # 'module.module.features.6.conv.6.weight',
    'module.module.features.6.conv.7.weight',
    # 'module.module.features.7.conv.0.weight',
    'module.module.features.7.conv.1.weight',
    # 'module.module.features.7.conv.3.weight',
    'module.module.features.7.conv.4.weight',
    # 'module.module.features.7.conv.6.weight',
    'module.module.features.7.conv.7.weight',
    # 'module.module.features.8.conv.0.weight',
    'module.module.features.8.conv.1.weight',
    # 'module.module.features.8.conv.3.weight',
    'module.module.features.8.conv.4.weight',
    # 'module.module.features.8.conv.6.weight',
    'module.module.features.8.conv.7.weight',
    # 'module.module.features.9.conv.0.weight',
    'module.module.features.9.conv.1.weight',
    # 'module.module.features.9.conv.3.weight',
    'module.module.features.9.conv.4.weight',
    # 'module.module.features.9.conv.6.weight',
    'module.module.features.9.conv.7.weight',
    # 'module.module.features.10.conv.0.weight',
    'module.module.features.10.conv.1.weight',
    # 'module.module.features.10.conv.3.weight',
    'module.module.features.10.conv.4.weight',
    # 'module.module.features.10.conv.6.weight',
    'module.module.features.10.conv.7.weight',
    # 'module.module.features.11.conv.0.weight',
    'module.module.features.11.conv.1.weight',
    # 'module.module.features.11.conv.3.weight',
    'module.module.features.11.conv.4.weight',
    # 'module.module.features.11.conv.6.weight',
    'module.module.features.11.conv.7.weight',
    # 'module.module.features.12.conv.0.weight',
    'module.module.features.12.conv.1.weight',
    # 'module.module.features.12.conv.3.weight',
    'module.module.features.12.conv.4.weight',
    # 'module.module.features.12.conv.6.weight',
    'module.module.features.12.conv.7.weight',
    # 'module.module.features.13.conv.0.weight',
    'module.module.features.13.conv.1.weight',
    # 'module.module.features.13.conv.3.weight',
    'module.module.features.13.conv.4.weight',
    # 'module.module.features.13.conv.6.weight',
    'module.module.features.13.conv.7.weight',
    # 'module.module.features.14.conv.0.weight',
    'module.module.features.14.conv.1.weight',
    # 'module.module.features.14.conv.3.weight',
    'module.module.features.14.conv.4.weight',
    # 'module.module.features.14.conv.6.weight',
    'module.module.features.14.conv.7.weight',
    # 'module.module.features.15.conv.0.weight',
    'module.module.features.15.conv.1.weight',
    # 'module.module.features.15.conv.3.weight',
    'module.module.features.15.conv.4.weight',
    # 'module.module.features.15.conv.6.weight',
    'module.module.features.15.conv.7.weight',
    # 'module.module.features.16.conv.0.weight',
    'module.module.features.16.conv.1.weight',
    # 'module.module.features.16.conv.3.weight',
    'module.module.features.16.conv.4.weight',
    # 'module.module.features.16.conv.6.weight',
    'module.module.features.16.conv.7.weight',
    # 'module.module.features.17.conv.0.weight',
    'module.module.features.17.conv.1.weight',
    # 'module.module.features.17.conv.3.weight',
    'module.module.features.17.conv.4.weight',
    # 'module.module.features.17.conv.6.weight',
    'module.module.features.17.conv.7.weight',
    # 'module.module.features.18.0.weight',
    'module.module.features.18.1.weight']
    # 'module.module.classifier.1.weight']

  mobilenetv2_fullyconnected:
    class: 'SparsityLevelParameterPruner'
    group_type: Element
    # 80% sparsity of dropout and fully connected layers
    desired_sparsity: 0.8
    # NOTE: 18.1 is a dropout layer, do you really want to prune it?
    weights: ['module.module.features.18.1.weight',
    'module.module.classifier.1.weight']


lr_schedulers:
  # Learning rate decay scheduler
  pruning_lr:
    class: StepLR
    step_size: 50
    gamma: 0.10


policies:
  # NOTE: apply pruning for first epoch only
  - pruner:
      instance_name: mobilenetv2_conv
    epochs: [0]
  - pruner:
      instance_name: mobilenetv2_batchnorm
    epochs: [0]
  - pruner:
      instance_name: mobilenetv2_fullyconnected
    epochs: [0]

  # - extension:
  #     instance_name: net_thinner
  #   epochs: [0]
